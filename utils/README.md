# Excel数据处理工具

这个工具专门用于处理学生健康数据的Excel导入问题，特别是解决数值字段（身高、体重、胸围、肺活量等）无法正确导入的问题。

## 问题背景

在原有系统中，从Excel导入的学生信息中，身高、体重、胸围和肺活量的数值字段会变成null，而手动输入却能正确保存。这主要由以下几个问题导致：

1. Excel中的数值格式多样，可能包含单位、非标准字符等
2. 不同区域设置下，小数点表示可能不同（点号或逗号）
3. Excel中的空值处理不一致
4. 数据类型转换逻辑不够健壮

## 解决方案

我们创建了一个专门的Excel处理器（`ExcelProcessor`类）来解决这个问题，主要功能包括：

1. 支持多种列名格式（如"身高"、"身高(cm)"、"身高（cm）"等）
2. 智能清理数值字符串（移除单位、非数字字符等）
3. 统一处理小数点表示（支持点号和逗号）
4. 健壮的类型转换（特别处理零值和空值）
5. 详细的日志记录，便于调试问题

## 使用方法

### 在服务器中使用

这个工具已经集成到服务器的导入流程中。原来的Excel导入过程被替换为新的处理逻辑，不需要额外操作。

### 独立测试工具

提供了`test_excel_import.py`脚本，可以单独测试Excel文件的处理：

```bash
python test_excel_import.py 文件路径.xlsx
```

运行后将显示处理结果，并生成一个JSON文件，包含解析出的学生数据。

### 在其他项目中复用

如果需要在其他项目中使用这个工具，只需引入ExcelProcessor类：

```python
from utils.excel_processor import ExcelProcessor

processor = ExcelProcessor()
result = processor.process_file("学生数据.xlsx")

if 'error' in result:
    print(f"处理出错: {result['error']}")
else:
    students = result['students']
    print(f"成功解析 {len(students)} 名学生数据")
```

## 数据处理流程

1. **读取Excel文件**：使用pandas库读取Excel文件
2. **验证必要列**：检查是否包含必需的列（学号、姓名、性别）
3. **预处理数据**：
   - 将所有数值列转为字符串
   - 清理数值字符串（移除非数字字符）
   - 统一小数点表示（逗号替换为点号）
   - 处理空值和特殊值
4. **类型转换**：将清理后的字符串转换为浮点数
5. **生成学生数据**：构建标准格式的学生数据对象
6. **生成HTML预览**：为导入预览生成HTML表格

## 扩展和定制

ExcelProcessor类设计为可扩展的，如果需要支持更多的字段或不同的数据格式，可以修改以下部分：

1. `column_mapping`：添加更多的列名映射
2. `numeric_columns`：定义哪些列需要作为数值处理
3. `_clean_numeric_string`方法：自定义数值清理逻辑
4. `_generate_html_preview`方法：自定义HTML预览格式

## 日志和调试

工具内置了详细的日志记录，可以通过查看日志文件来排查问题。日志记录了：

1. 原始数据的结构和类型
2. 每一步数据转换的结果
3. 最终生成的学生数据

## 注意事项

1. 确保Excel模板中的列名与系统预期一致
2. 对于需要保留小数的数值，推荐使用点号作为小数点
3. 空值将被转换为null，零值会被正确保留 